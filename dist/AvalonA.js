// Generated by CoffeeScript 1.9.3
(function() {
  var ActiveArea, Layer, Signal, defineAvalonA, ref,
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  ActiveArea = (function() {
    var dimensionPattern, validDimension;

    dimensionPattern = /^\d+(%|px)?$/gi;

    validDimension = function(dimension) {
      var result;
      dimensionPattern.lastIndex = 0;
      result = dimensionPattern.test(dimension);
      dimensionPattern.lastIndex = 0;
      return result;
    };

    ActiveArea.prototype.assertValid = function() {
      var errors, ref;
      errors = ['The following validation errors occured:'];
      if (typeof this.position !== 'object') {
        if (this.position !== 'auto') {
          errors.push("area.position is not valid (" + this.position + ")");
        }
      } else {
        if (this.position.x !== 'auto' && !validDimension(this.position.x)) {
          errors.push("area.position.x is not valid (" + this.position.x + "})");
        }
        if (this.position.y !== 'auto' && !validDimension(this.position.y)) {
          errors.push("area.position.y is not valid (" + this.position.y + "})");
        }
      }
      if ((ref = this.attachment) !== 'fixed' && ref !== 'scroll') {
        errors.push("area.attachment is not valid (" + this.attachment + ")");
      }
      if (!validDimension(this.area.width)) {
        errors.push("area.width is not valid (" + this.area.width + ")");
      }
      if (!validDimension(this.area.height)) {
        errors.push("area.height is not valid (" + this.area.height + ")");
      }
      if (errors.length > 1) {
        throw new Error(errors.join("\n"));
      }
    };

    ActiveArea.prototype.processActiveArea = function() {
      this.width = parseInt(this.area.width, 10);
      this.widthIsFluid = dimensionPattern.exec(this.area.width)[1] === '%';
      dimensionPattern.lastIndex = 0;
      this.height = parseInt(this.area.height, 10);
      this.heightIsFluid = dimensionPattern.exec(this.area.height)[1] === '%';
      dimensionPattern.lastIndex = 0;
      if (typeof this.position === 'object') {
        if (this.position.x !== 'auto') {
          this.x = parseInt(this.position.x, 10);
        }
        if (this.position.y !== 'auto') {
          return this.y = parseInt(this.position.y, 10);
        }
      }
    };

    ActiveArea.prototype.init = function(frame) {
      var frameScrollCount, resizeDebugCode, scrollDebugCode, self, windowScrollCount, xBaseComputation, yBaseComputation;
      this.frame = frame;
      if (!this.frame) {
        throw new Error("frame argument cannot be null");
      }
      this.xBase = (xBaseComputation = this.getXBaseComputation())();
      this.yBase = (yBaseComputation = this.getYBaseComputation())();
      if (this.widthIsFluid) {
        this.xMaxComputation = function() {
          return this.xMin + (this.width / 100) * parseInt(getComputedStyle(this.frame).width, 10);
        };
      } else {
        this.xMaxComputation = function() {
          return this.xMin + this.width;
        };
      }
      if (this.heightIsFluid) {
        this.yMaxComputation = function() {
          return this.yMin + (this.height / 100) * parseInt(getComputedStyle(this.frame).height, 10);
        };
      } else {
        this.yMaxComputation = function() {
          return this.yMin + this.height;
        };
      }
      if (this.attachment === 'fixed') {
        this.xPadding = this.frame.scrollLeft;
        this.yPadding = this.frame.scrollTop;
        if (this.debug === true) {
          console.log("Listen to scroll event");
          self = this;
          scrollDebugCode = function() {
            return console.log("Scroll : @xPadding = " + self.xPadding + ", @yPadding = " + self.yPadding);
          };
        } else {
          scrollDebugCode = function() {};
        }
        windowScrollCount = 0;
        window.addEventListener('scroll', (function(_this) {
          return function() {
            if (++windowScrollCount % 5 > 0) {
              return;
            }
            _this.xPadding = window.pageXOffset;
            _this.yPadding = window.pageYOffset;
            _this.refreshBounds();
            return scrollDebugCode();
          };
        })(this), false);
        frameScrollCount = 0;
        this.frame.addEventListener('scroll', (function(_this) {
          return function() {
            if (++frameScrollCount % 5 > 0) {
              return;
            }
            _this.xPadding = _this.frame.scrollLeft;
            _this.yPadding = _this.frame.scrollTop;
            _this.refreshBounds();
            return scrollDebugCode();
          };
        })(this), false);
      } else {
        this.xPadding = this.yPadding = 0;
      }
      if (this.debug === true) {
        self = this;
        resizeDebugCode = function() {
          return console.log("Resize : @frame.style.width = " + (getComputedStyle(self.frame).width) + ", @frame.style.height = " + (getComputedStyle(self.frame).height));
        };
      } else {
        resizeDebugCode = function() {};
      }
      window.addEventListener('resize', (function(_this) {
        return function() {
          _this.xBase = xBaseComputation();
          _this.yBase = yBaseComputation();
          _this.refreshBounds();
          return resizeDebugCode();
        };
      })(this), false);
      return this.refreshBounds();
    };

    ActiveArea.prototype.refreshBounds = function() {
      this.xMin = this.xBase + this.xPadding;
      this.xMax = this.xMaxComputation();
      this.yMin = this.yBase + this.yPadding;
      return this.yMax = this.yMaxComputation();
    };

    ActiveArea.prototype.bounds = function() {
      return {
        xMin: this.xMin,
        xMax: this.xMax,
        yMin: this.yMin,
        yMax: this.yMax
      };
    };

    ActiveArea.prototype.getXBaseComputation = function() {
      var frameWidth, xBaseComputation;
      frameWidth = parseInt(getComputedStyle(this.frame).width, 10);
      if (this.position.x && this.position.x !== 'auto') {
        if (dimensionPattern.exec(this.position.x)[1] === '%') {
          xBaseComputation = (function(_this) {
            return function() {
              return (_this.x / 100) * frameWidth;
            };
          })(this);
        } else {
          xBaseComputation = (function(_this) {
            return function() {
              return _this.x;
            };
          })(this);
        }
        dimensionPattern.lastIndex = 0;
      } else {
        if (this.widthIsFluid) {
          xBaseComputation = (function(_this) {
            return function() {
              return ((50 - _this.width / 2) / 100) * frameWidth;
            };
          })(this);
        } else {
          xBaseComputation = (function(_this) {
            return function() {
              return frameWidth / 2 - _this.width / 2;
            };
          })(this);
        }
      }
      return xBaseComputation;
    };

    ActiveArea.prototype.getYBaseComputation = function() {
      var frameHeight, yBaseComputation;
      frameHeight = parseInt(getComputedStyle(this.frame).height, 10);
      if (this.position.y && this.position.y !== 'auto') {
        if (dimensionPattern.exec(this.position.y)[1] === '%') {
          yBaseComputation = (function(_this) {
            return function() {
              return (_this.y / 100) * frameHeight;
            };
          })(this);
        } else {
          yBaseComputation = (function(_this) {
            return function() {
              return _this.y;
            };
          })(this);
        }
        dimensionPattern.lastIndex = 0;
      } else {
        if (this.heightIsFluid) {
          yBaseComputation = (function(_this) {
            return function() {
              return ((50 - _this.height / 2) / 100) * frameHeight;
            };
          })(this);
        } else {
          yBaseComputation = (function(_this) {
            return function() {
              return frameHeight / 2 - _this.height / 2;
            };
          })(this);
        }
      }
      return yBaseComputation;
    };

    ActiveArea.prototype.mouseover = function(event) {
      var ref, ref1;
      return (this.xMin <= (ref = event.pageX) && ref <= this.xMax) && (this.yMin <= (ref1 = event.pageY) && ref1 <= this.yMax);
    };

    function ActiveArea(area) {
      var base, base1;
      this.area = area;
      if (!this.area) {
        throw new Error("area argument is missing");
      }
      this.position = this.area.position || 'auto';
      if (typeof this.position === 'object') {
        if ((base = this.position).x == null) {
          base.x = 'auto';
        }
        if ((base1 = this.position).y == null) {
          base1.y = 'auto';
        }
        if (this.position.x === 'auto' && this.position.y === 'auto') {
          this.position = 'auto';
        }
      }
      this.attachment = this.area.attachment || 'fixed';
      this.assertValid();
      this.processActiveArea();
    }

    return ActiveArea;

  })();

  Signal = (function() {
    function Signal() {}

    Signal.prototype.register = function(listener) {
      if (typeof listener === 'function') {
        return (this._listeners != null ? this._listeners : this._listeners = []).push(listener);
      }
    };

    Signal.prototype.unregister = function(listener) {
      var index;
      if (this._listeners) {
        index = this._listeners.indexOf(listener);
        if (!(index < 0)) {
          return this._listeners.splice(index, 1);
        }
      }
    };

    Signal.prototype.clear = function() {
      return this._listener = void 0;
    };

    Signal.prototype.send = function(sender, data) {
      var i, len, listener, ref, results, Ø;
      if (this._listeners) {
        Ø = {};
        ref = this._listeners;
        results = [];
        for (i = 0, len = ref.length; i < len; i++) {
          listener = ref[i];
          results.push(listener.call(Ø, sender, data));
        }
        return results;
      }
    };

    return Signal;

  })();

  Layer = (function() {
    var fn, i, len, property, ref;

    Layer.properties = ['x', 'y', 'z', 'rx', 'ry', 'rz'];

    ref = Layer.properties;
    fn = function(property) {
      var propertyPattern;
      propertyPattern = new RegExp("\\b" + property + "\\s*:\\s*(-?\\w+)\\b");
      return Object.defineProperty(Layer.prototype, property, {
        get: function() {
          var ref1, transforms;
          transforms = this.node.getAttribute(this._transformAttribute);
          return parseInt(((ref1 = propertyPattern.exec(transforms)) != null ? ref1[1].trim() : void 0) || 0, 10);
        },
        set: function(value) {
          var newTransforms, numericValue, transforms;
          numericValue = parseInt(value, 10);
          if (isNaN(numericValue)) {
            throw "[Layer] - set " + property + " - value (" + value + ") is not valid";
          }
          transforms = (this.node.getAttribute(this._transformAttribute)).trim();
          if (propertyPattern.test(transforms)) {
            newTransforms = transforms.replace(propertyPattern, property + ":" + numericValue);
          } else {
            newTransforms = property + ":" + numericValue;
            if (transforms) {
              newTransforms = transforms + "; " + newTransforms;
            }
          }
          return this.node.setAttribute(this._transformAttribute, newTransforms);
        }
      });
    };
    for (i = 0, len = ref.length; i < len; i++) {
      property = ref[i];
      fn(property);
    }

    function Layer(node1, _transformAttribute) {
      var cssClass;
      this.node = node1;
      this._transformAttribute = _transformAttribute;
      if (this.node.id) {
        this.id = this.node.id;
      }
      if (this.node.className) {
        this.classes = (function() {
          var j, len1, ref1, results;
          ref1 = this.node.className.split(/\s+/g);
          results = [];
          for (j = 0, len1 = ref1.length; j < len1; j++) {
            cssClass = ref1[j];
            results.push(cssClass);
          }
          return results;
        }).call(this);
      }
      this.on = {
        refresh: new Signal
      };
    }

    Layer.prototype.refresh = function() {
      return this.on.refresh.send(this);
    };

    Layer.prototype.transform = function(properties) {
      var results, value;
      results = [];
      for (property in properties) {
        value = properties[property];
        if (indexOf.call(Layer.properties, property) >= 0) {
          results.push(this[property] = value);
        }
      }
      return results;
    };

    return Layer;

  })();


  /* AvalonA 1.0.0 */

  console.log('%cAvalonA 1.0.0', 'font-size:80%;padding:0.2em 0.5em;color:#FFFFD5;background-color:#FF0066;');

  defineAvalonA = function(TweenLite) {
    var Frame3d;
    Frame3d = (function() {
      var cssBackUpAttribute, debugName, detectTransformStyleSupport, getTransformStyle, noeffect, transformStyleIsSupported, transitionDuration;

      transitionDuration = 0.75;

      noeffect = function(rotation) {
        return rotation;
      };

      transformStyleIsSupported = void 0;

      cssBackUpAttribute = 'data-css-backup';

      detectTransformStyleSupport = function() {
        var element;
        if (transformStyleIsSupported === void 0) {
          element = document.createElement('b');
          element.id = 'avalona-detection-element';
          element.style.position = 'absolute';
          element.style.top = 0;
          element.style.left = 0;
          document.body.appendChild(element);
          element.style.webkitTransformStyle = 'preserve-3d';
          element.style.MozTransformStyle = 'preserve-3d';
          element.style.msTransformStyle = 'preserve-3d';
          element.style.transformStyle = 'preserve-3d';
          transformStyleIsSupported = getTransformStyle(element) === 'preserve-3d';
          document.body.removeChild(element);
        }
        return transformStyleIsSupported;
      };

      getTransformStyle = function(element) {
        var computedStyle;
        computedStyle = getComputedStyle(element, null);
        return computedStyle.getPropertyValue('-webkit-transform-style') || computedStyle.getPropertyValue('-moz-transform-style') || computedStyle.getPropertyValue('-ms-transform-style') || computedStyle.getPropertyValue('transform-style');
      };

      debugName = function(node) {
        return node.tagName + "(" + (node.id || node.getAttribute('class') || node.getAttribute('href')) + ")";
      };

      Frame3d.prototype.find3dFrames = function() {
        this.frame = document.getElementById(this.frameId);
        this.transformedLayer = this.frame.querySelector("#" + this.layerId);
        if (this.debug === true) {
          console.log("@transformAttribute: " + this.transformAttribute);
          console.log("@layerId: " + this.layerId);
        }
        if (!this.frame) {
          throw new Error("Cannot find 3d frame '#" + this.frameId + "' in dom");
        }
        if (!this.transformedLayer) {
          throw new Error("Cannot find 3d inner frame '#" + this.frameId + " > #" + this.layerId + "' in dom");
        }
      };

      Frame3d.prototype.addPerspective = function() {
        return TweenLite.set(this.transformedLayer, {
          css: {
            perspective: 1000
          }
        });
      };

      Frame3d.prototype.removePerspective = function() {
        return TweenLite.set(this.transformedLayer, {
          css: {
            perspective: 'none'
          }
        });
      };

      Frame3d.prototype.trackMouseMovements = function() {
        var activeAreaPlaceholder, activeAreaPlaceholderId, ref, rule, value;
        if (this.debug === true && this.activeArea) {
          activeAreaPlaceholderId = 'avalona-active-area';
          activeAreaPlaceholder = document.getElementById(activeAreaPlaceholderId) || document.createElement('div');
          activeAreaPlaceholder.textContent = 'AvalonA Active Area';
          activeAreaPlaceholder.id = activeAreaPlaceholderId;
          ref = {
            'background-color': 'hotpink',
            'opacity': 0.5,
            'pointer-events': 'none',
            'position': 'absolute',
            'visibility': 'hidden',
            'z-index': 10000
          };
          for (rule in ref) {
            value = ref[rule];
            activeAreaPlaceholder.style.setProperty(rule, value);
          }
          document.body.appendChild(activeAreaPlaceholder);
          this.debugMouseMove = function() {
            var bounds, ref1, results;
            console.log("rotationX: " + this.rotationX + ", rotationY: " + this.rotationY);
            bounds = this.activeArea.bounds();
            ref1 = {
              visibility: 'visible',
              left: bounds.xMin + "px",
              top: bounds.yMin + "px",
              width: (bounds.xMax - bounds.xMin) + "px",
              height: (bounds.yMax - bounds.yMin) + "px"
            };
            results = [];
            for (rule in ref1) {
              value = ref1[rule];
              results.push(activeAreaPlaceholder.style.setProperty(rule, value));
            }
            return results;
          };
        } else {
          this.debugMouseMove = function() {};
        }
        if (this.activeArea) {
          this.activeArea.init(this.frame);
        } else {
          this.frame.addEventListener('mouseleave', function(e) {
            if (e.target.id === this.frameId) {
              return this.mouseout();
            }
          }, false);
        }
        return this.frame.addEventListener('mousemove', this.mousemove, false);
      };

      Frame3d.prototype.mouseout = function() {
        return this.disableRotation();
      };

      Frame3d.prototype.mouseMoveCount = 0;

      Frame3d.prototype.mousemove = function(event) {
        if (++this.mouseMoveCount % 5 > 0) {
          return;
        }
        if (!this.activeArea || this.activeArea.mouseover(event)) {
          this.onrotation();
          this.rotationY = (event.pageX - window.innerWidth / 2) / 25;
          this.rotationX = -1 * (event.pageY - window.innerHeight / 2) / 15;
          this.debugMouseMove();
          return TweenLite.to(this.transformedLayer, 0.1, {
            css: {
              rotationX: this.fy(this.rotationX),
              rotationY: this.fx(this.rotationY)
            }
          });
        } else {
          return this.disableRotation();
        }
      };

      Frame3d.prototype.onrotation = function() {
        var ref;
        clearTimeout(this.rotationTimeoutId);
        if (!this.rotating) {
          if ((ref = this.animation) != null) {
            ref.pause();
          }
          if (typeof this.onstartrotation === "function") {
            this.onstartrotation();
          }
          this.rotating = true;
        }
        if (this.idleTimeout > 0) {
          return this.rotationTimeoutId = setTimeout(this.stopRotation, this.idleTimeout);
        }
      };

      Frame3d.prototype.stopRotation = function() {
        var ref;
        clearTimeout(this.rotationTimeoutId);
        if (this.rotating) {
          this.rotating = false;
          if (typeof this.onendrotation === "function") {
            this.onendrotation();
          }
          return (ref = this.animation) != null ? ref.play() : void 0;
        }
      };

      Frame3d.prototype.disableRotation = function(duration) {
        if (duration == null) {
          duration = 1;
        }
        if ((this.rotationX || this.rotationY) && (this.animation == null)) {
          this.resetRotation(duration);
        }
        return this.stopRotation();
      };

      Frame3d.prototype.resetRotation = function(duration) {
        if (duration == null) {
          duration = 1;
        }
        clearTimeout(this.rotationTimeoutId);
        this.rotationX = this.rotationY = 0;
        return TweenLite.to(this.transformedLayer, duration, {
          css: {
            rotationX: 0,
            rotationY: 0
          }
        });
      };

      Frame3d.prototype.resetTransform = function() {
        var ref, results, rule, value;
        clearTimeout(this.rotationTimeoutId);
        this.rotationX = this.rotationY = 0;
        ref = {
          '-webkit-transform': 'none',
          '-moz-transform': 'none',
          '-o-transform': 'none',
          '-ms-transform': 'none',
          'transform': 'none'
        };
        results = [];
        for (rule in ref) {
          value = ref[rule];
          results.push(this.transformedLayer.style.setProperty(rule, value));
        }
        return results;
      };

      Frame3d.prototype.untrackMouseMovements = function() {
        var ref, ref1;
        if ((ref = this.frame) != null) {
          ref.removeEventListener("mousemove", this.mousemove);
        }
        return (ref1 = this.frame) != null ? ref1.removeEventListener("mouseleave", this.mouseout) : void 0;
      };

      Frame3d.prototype.refreshTransform = function(root) {
        var child, classSelector, cssClass, fromRoot, i, j, k, layer, layers, len, len1, len2, ref, ref1, ref2, ref3, rootNode, subLayers;
        if (this.disabled === true) {
          return;
        }
        if (typeof root === 'string') {
          root = root.trim();
        }
        fromRoot = !root || root === this.transformedLayer;
        if (root == null) {
          root = this.transformedLayer;
        }
        rootNode = typeof root === 'string' ? this.transformedLayer.querySelector(root) : root;
        if (this.debug === true) {
          console.log("rootNode: " + (debugName(rootNode)));
        }
        this.applyTransformOn(rootNode);
        if (this.debug === true) {
          console.log("refreshTransform firstChild: " + (debugName(rootNode.firstElementChild)));
        }
        layers = {
          all: []
        };
        ref = rootNode.children;
        for (i = 0, len = ref.length; i < len; i++) {
          child = ref[i];
          subLayers = this.refreshChildTransform(child);
          if (subLayers) {
            (ref1 = layers.all).push.apply(ref1, subLayers);
          }
        }
        if (!fromRoot && rootNode.getAttribute(this.transformAttribute)) {
          layers.root = new Layer(rootNode, this.transformAttribute);
          layers.all.push(layers.root);
        }
        if (fromRoot) {
          this.layers = layers;
          ref2 = layers.all;
          for (j = 0, len1 = ref2.length; j < len1; j++) {
            layer = ref2[j];
            if (layer.id) {
              layers["#" + layer.id] = layer;
            }
            if (!layer.registered) {
              layer.registered = true;
              layer.on.refresh.register((function(_this) {
                return function(layer) {
                  return _this.refreshTransform(layer.node);
                };
              })(this));
            }
            if (layer.classes) {
              ref3 = layer.classes;
              for (k = 0, len2 = ref3.length; k < len2; k++) {
                cssClass = ref3[k];
                classSelector = "." + cssClass;
                if (layers[classSelector] == null) {
                  layers[classSelector] = [];
                }
                layers[classSelector].push(layer);
              }
            }
          }
        }
        return layers;
      };

      Frame3d.prototype.refreshChildTransform = function(child) {
        if (!child) {
          throw new Error("refreshChildTransform child argument cannot be null");
        }
        if (child.querySelectorAll("[" + this.transformAttribute + "]").length) {
          if (this.debug === true) {
            console.log("refreshTransform child " + (debugName(child)) + " has children");
          }
          return this.refreshTransform(child).all;
        } else if (child.getAttribute(this.transformAttribute)) {
          if (this.debug === true) {
            console.log("refreshTransform child " + (debugName(child)) + " has '" + this.transformAttribute + "'");
          }
          this.applyTransformOn(child);
        }
        if (child.getAttribute(this.transformAttribute)) {
          return [new Layer(child, this.transformAttribute)];
        }
      };

      Frame3d.prototype.applyTransformOn = function(target) {
        var attrValue, backup, css, i, len, prop, ref, ref1, rx, ry, rz, t, targetStyle, transformBackup, transforms, value, x, y, z;
        if (!target) {
          throw new Error("applyTransformOn target argument cannot be null");
        }
        if (!target.getAttribute(cssBackUpAttribute)) {
          targetStyle = getComputedStyle(target);
          backup = {
            transformStyle: getTransformStyle(target) || 'flat',
            overflow: targetStyle.overflow || 'inherit'
          };
          transformBackup = targetStyle.getPropertyValue('-webkit-transform') || targetStyle.getPropertyValue('-moz-transform') || targetStyle.getPropertyValue('-o-transform') || targetStyle.getPropertyValue('-ms-transform') || targetStyle.getPropertyValue('transform');
          if (transformBackup) {
            backup.transform = transformBackup;
          }
          target.setAttribute(cssBackUpAttribute, JSON.stringify(backup));
        }
        TweenLite.set(target, {
          css: {
            transformStyle: 'preserve-3d',
            overflow: 'visible'
          }
        });
        if ((attrValue = target.getAttribute(this.transformAttribute))) {
          transforms = {};
          ref = attrValue.split(';');
          for (i = 0, len = ref.length; i < len; i++) {
            t = ref[i];
            ref1 = t.split(':'), prop = ref1[0], value = ref1[1];
            transforms[prop.trim()] = parseInt(value.trim(), 10);
          }
          x = transforms.x, y = transforms.y, z = transforms.z, rx = transforms.rx, ry = transforms.ry, rz = transforms.rz;
          if (x || y || z || rx || ry || rz) {
            css = {};
            if (x) {
              css.x = x;
            }
            if (y) {
              css.y = y;
            }
            if (z) {
              css.z = z;
            }
            if (rx) {
              css.rotationX = rx;
            }
            if (ry) {
              css.rotationY = ry;
            }
            if (rz) {
              css.rotationZ = rz;
            }
            return TweenLite.to(target, transitionDuration, {
              css: css
            });
          }
        }
      };

      Frame3d.prototype.refresh = function() {
        var error, layers, ref, ref1;
        this.disabled = false;
        if (!this.ready) {
          try {
            if (typeof this.onready === "function") {
              this.onready();
            }
          } catch (_error) {
            error = _error;
            console.error('AvalonA - refresh - Error occured on ready', error);
          }
          this.ready = true;
        }
        if (this.frame) {
          this.untrackMouseMovements();
          if ((ref = this.animation) != null) {
            ref.pause();
          }
        }
        this.find3dFrames();
        this.addPerspective();
        layers = this.refreshTransform();
        this.trackMouseMovements();
        if (typeof this.onrefresh === "function") {
          this.onrefresh();
        }
        if ((ref1 = this.animation) != null) {
          ref1.play(this.transformedLayer, this.transformAttribute);
        }
        return layers;
      };

      Frame3d.prototype.start = function() {
        return this.refresh();
      };

      Frame3d.prototype.enable = function() {
        return this.refresh();
      };

      Frame3d.prototype.disable = function() {
        var ref;
        if (this.frame) {
          this.untrackMouseMovements();
          this.disableRotationEvent();
          if ((ref = this.animation) != null) {
            ref.pause();
          }
          this.flatten();
          this.removePerspective();
        }
        return this.disabled = true;
      };

      Frame3d.prototype.disableRotationEvent = function() {
        clearTimeout(this.rotationTimeoutId);
        this.rotating = false;
        return typeof this.onendrotation === "function" ? this.onendrotation() : void 0;
      };

      Frame3d.prototype.flatten = function() {
        var css, i, len, node, ref, results;
        this.resetTransform();
        ref = this.transformedLayer.querySelectorAll("[" + cssBackUpAttribute + "]");
        results = [];
        for (i = 0, len = ref.length; i < len; i++) {
          node = ref[i];
          if (this.debug === true) {
            console.log("flattening layer '" + (debugName(node)) + "'");
          }
          css = JSON.parse(node.getAttribute(cssBackUpAttribute));
          results.push(TweenLite.set(node, {
            css: css
          }));
        }
        return results;
      };

      Frame3d.prototype.init = function(options) {
        var ref, ref1, ref2, ref3;
        this.transformAttribute = options.tAttr || 'data-avalonA-transform';
        this.fx = typeof options.fx === 'function' ? options.fx : noeffect;
        this.fy = typeof options.fy === 'function' ? options.fy : noeffect;
        if (options.activeArea) {
          this.activeArea = new ActiveArea(options.activeArea);
        }
        if ((ref = this.activeArea) != null) {
          ref.debug = this.debug;
        }
        this.onstartrotation = (ref1 = options.on) != null ? ref1.startrotation : void 0;
        this.onendrotation = (ref2 = options.on) != null ? ref2.endrotation : void 0;
        this.onready = (ref3 = options.on) != null ? ref3.ready : void 0;
        this.onrefresh = options.on && (options.on.refresh || options.on.enable || options.on.start);
        this.animation = options.animation;
        this.idleTimeout = parseInt(options.idleTimeout || 1000, 10);
        if (this.animation) {
          this.assertAnimatorValid();
        }
        return Object.defineProperties(this, {
          onenable: {
            get: function() {
              return this.onrefresh;
            },
            set: function(onenable) {
              return this.onrefresh = onenable;
            }
          },
          onstart: {
            get: function() {
              return this.onrefresh;
            },
            set: function(onstart) {
              return this.onrefresh = onstart;
            }
          }
        });
      };

      Frame3d.prototype.assertAnimatorValid = function() {
        if (!this.animation.play || typeof this.animation.play !== 'function') {
          throw new Error("animation.play must be a function");
        }
        if (!this.animation.pause || typeof this.animation.pause !== 'function') {
          throw new Error("animation.pause must be a function");
        }
      };

      function Frame3d(frameId1, layerId1, options) {
        this.frameId = frameId1;
        this.layerId = layerId1;
        if (options == null) {
          options = {};
        }
        this.refreshChildTransform = bind(this.refreshChildTransform, this);
        this.stopRotation = bind(this.stopRotation, this);
        this.mousemove = bind(this.mousemove, this);
        this.mouseout = bind(this.mouseout, this);
        if (!this.frameId) {
          throw new Error("frameId argument cannot be null");
        }
        if (!this.layerId) {
          throw new Error("layerId argument cannot be null");
        }
        this.debug = options.debug;
        detectTransformStyleSupport();
        if (this.debug === true) {
          console.log("transformStyleIsSupported: " + transformStyleIsSupported);
        }
        if (transformStyleIsSupported) {
          this.init(options);
        } else {
          this.flatten = this.disableRotationEvent = this.disable = this.start = this.enable = this.refresh = this.applyTransformOn = this.refreshChildTransform = this.refreshTransform = this.untrackMouseMovements = this.trackMouseMovements = this.addPerspective = this.removePerspective = function() {};
        }
      }

      return Frame3d;

    })();
    return function(frameId, layerId, options) {
      return new Frame3d(frameId, layerId, options);
    };
  };


  /* Export */

  if (typeof define === 'function' && define.amd) {
    define('AvalonA', ['tweenlite'], function(tweenlite) {
      return defineAvalonA(tweenlite);
    });
  } else {
    window.AvalonA = defineAvalonA(((ref = window.GreenSockGlobals) != null ? ref.TweenLite : void 0) || TweenLite);
  }

}).call(this);
